{% extends "base.html" %}
{% load static %}
{% block title %}Сканер QR - Система учета посещений{% endblock %}

{% block content %}
<div class="container-fluid bg-light min-vh-100 py-4">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-lg border-0 rounded-3">
          <div class="card-header bg-white border-0 p-4">
            <div class="text-center">
              <div class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 rounded-circle mb-3" style="width: 60px; height: 60px;">
                <i class="bi-qr-code-scan text-primary" style="font-size: 1.5rem;"></i>
              </div>
              <h2 class="h4 fw-bold mb-2">Сканирование QR-кода</h2>
              <p class="text-muted mb-0">Наведите камеру на QR-код или введите токен вручную</p>
            </div>
          </div>
          
          <div class="card-body p-4">
            <!-- Camera Scanner -->
            <div class="text-center mb-4">
              <div class="position-relative d-inline-block">
                <video id="qr-video" class="border border-3 border-primary rounded-3" style="max-width: 100%; max-height: 300px;" muted autoplay></video>
                <div class="position-absolute top-50 start-50 translate-middle" style="width: 100px; height: 100px; border: 2px solid #007bff; border-radius: 10px; pointer-events: none;">
                  <div class="position-absolute" style="top: -2px; left: -2px; width: 20px; height: 20px; border-top: 2px solid #007bff; border-left: 2px solid #007bff;"></div>
                  <div class="position-absolute" style="top: -2px; right: -2px; width: 20px; height: 20px; border-top: 2px solid #007bff; border-right: 2px solid #007bff;"></div>
                  <div class="position-absolute" style="bottom: -2px; left: -2px; width: 20px; height: 20px; border-bottom: 2px solid #007bff; border-left: 2px solid #007bff;"></div>
                  <div class="position-absolute" style="bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 2px solid #007bff; border-right: 2px solid #007bff;"></div>
                </div>
              </div>
              
              <div class="mt-3">
                <div class="d-inline-flex align-items-center bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">
                  <i class="bi-camera me-2"></i>
                  <span class="small fw-medium">Результат: </span>
                  <span id="qr-result" class="ms-1 small">ожидание...</span>
                </div>
              </div>
            </div>

            <div class="text-center mb-4">
              <div class="d-inline-flex align-items-center text-muted">
                <div class="border-top flex-grow-1"></div>
                <span class="px-3 small">или</span>
                <div class="border-top flex-grow-1"></div>
              </div>
            </div>

            <!-- Manual Input Form -->
            <div class="row justify-content-center">
              <div class="col-md-8">
                <form id="qr-form" class="mb-3">
                  <div class="mb-3">
                    <label for="token" class="form-label fw-medium">
                      <i class="bi-keyboard me-1"></i>
                      Вставьте токен или ссылку:
                    </label>
                    <input type="text" id="token" name="token" class="form-control form-control-lg" placeholder="UUID токен или полная ссылка">
                  </div>
                  
                  <div class="mb-3" id="action-choice" style="display: none;">
                    <label class="form-label fw-medium">
                      <i class="bi-gear me-1"></i>
                      Выберите действие:
                    </label>
                    <div class="row g-3">
                      <div class="col-{% if has_exit_groups %}6{% else %}12{% endif %}">
                        <div class="form-check form-check-card">
                          <input class="form-check-input" type="radio" name="action" id="action-mark" value="mark" checked>
                          <label class="form-check-label d-flex align-items-center p-3 border rounded-3 cursor-pointer" for="action-mark">
                            <i class="bi-box-arrow-in-right text-success me-2"></i>
                            <span class="fw-medium">Отметить вход</span>
                          </label>
                        </div>
                      </div>
                      {% if has_exit_groups %}
                      <div class="col-6">
                        <div class="form-check form-check-card">
                          <input class="form-check-input" type="radio" name="action" id="action-leave" value="leave">
                          <label class="form-check-label d-flex align-items-center p-3 border rounded-3 cursor-pointer" for="action-leave">
                            <i class="bi-box-arrow-right text-danger me-2"></i>
                            <span class="fw-medium">Отметить выход</span>
                          </label>
                        </div>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill">
                      <i class="bi-arrow-right me-2"></i>
                      Перейти к отметке
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import QrScanner from "{% static 'js/qr-scanner/qr-scanner.min.js' %}";

  const video = document.getElementById('qr-video');
  const resultEl = document.getElementById('qr-result');

  const scanner = new QrScanner(video, result => {
    resultEl.textContent = result;
    resultEl.parentElement.className = 'd-inline-flex align-items-center bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill';

    if (result.includes("/qr/mark/") || result.includes("/qr/leave/")) {
      setTimeout(() => {
        window.location.href = result;
      }, 1000);
    } else {
      resultEl.textContent = "⚠️ Не является QR-кодом посещения";
      resultEl.parentElement.className = 'd-inline-flex align-items-center bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill';
    }

    scanner.stop();
  });

  scanner.start();

  const tokenInput = document.getElementById('token');
  const actionChoice = document.getElementById('action-choice');
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

  // Показываем/скрываем выбор действия в зависимости от типа ввода
  tokenInput.addEventListener('input', function() {
    const input = this.value.trim();
    
    if (input && uuidRegex.test(input)) {
      actionChoice.style.display = 'block';
    } else {
      actionChoice.style.display = 'none';
    }
  });

  document.getElementById('qr-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = tokenInput.value.trim();
    if (!input) {
      alert("Введите токен или ссылку");
      return;
    }

    // Проверяем, если это полная ссылка
    if (input.includes("/qr/mark/") || input.includes("/qr/leave/")) {
      window.location.href = input;
      return;
    }

    // Проверяем, если это UUID токен
    if (uuidRegex.test(input)) {
      const selectedAction = document.querySelector('input[name="action"]:checked').value;
      if (selectedAction === 'mark') {
        window.location.href = `/qr/mark/${input}/`;
      } else {
        window.location.href = `/qr/leave/${input}/`;
      }
      return;
    }

    alert("⚠️ Введите корректный токен (UUID) или полную ссылку");
  });
</script>

<style>
  .card {
    transition: all 0.3s ease;
  }
  
  .form-check-card .form-check-input {
    display: none;
  }
  
  .form-check-card .form-check-label {
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .form-check-card .form-check-input:checked + .form-check-label {
    background-color: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
  }
  
  .form-check-card .form-check-label:hover {
    background-color: var(--bs-light);
  }
  
  .form-check-card .form-check-input:checked + .form-check-label:hover {
    background-color: var(--bs-primary);
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .card {
    animation: fadeInUp 0.5s ease;
  }
  
  .cursor-pointer {
    cursor: pointer;
  }
  
  #qr-video {
    transition: all 0.3s ease;
  }
  
  #qr-video:hover {
    transform: scale(1.02);
  }
</style>
{% endblock %}
