{% extends "base.html" %}
{% load static %}

{% block title %}QR-коды - {{ session.group.code }} - {{ session.date }} - {{ block.super }}{% endblock %}

{% block content %}
    <!-- Content -->
    <div class="content container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center mb-3">
                <div class="col-sm mb-2 mb-sm-0">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb breadcrumb-no-gutter">
                            <li class="breadcrumb-item"><a class="breadcrumb-link" href="{% url 'groups:trainer_groups' %}">Мои группы</a></li>
                            <li class="breadcrumb-item"><a class="breadcrumb-link" href="{% url 'groups:group_detail' session.group.id %}">{{ session.group.code }}</a></li>
                            <li class="breadcrumb-item active" aria-current="page">QR-коды</li>
                        </ol>
                    </nav>
                    <h1 class="page-header-title">QR-коды для сессии <span class="badge bg-soft-dark text-dark ms-2">{{ session.date|date:"d.m.Y" }}</span></h1>
                </div>
                <!-- End Col -->

                <div class="col-sm-auto">
                    <div class="d-flex gap-2">
                        <a class="btn btn-outline-primary" href="{% url 'groups:group_detail' session.group.id %}">
                            <i class="bi-arrow-left me-1"></i> Назад к группе
                        </a>
                    </div>
                </div>
                <!-- End Col -->
            </div>
            <!-- End Row -->
        </div>
        <!-- End Page Header -->

        <!-- Messages -->
        {% if messages %}
            <div class="row mb-4">
                <div class="col-12">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        <!-- End Messages -->

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg avatar-4x3 avatar-soft-primary">
                                    <span class="avatar-initials"><i class="bi-calendar-date"></i></span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <span class="d-block h6 text-cap">Дата сессии</span>
                                <span class="d-block h4 mb-0">{{ session.date|date:"d.m.Y" }}</span>
                                <span class="d-block text-muted">{{ session.date|date:"l" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg avatar-4x3 avatar-soft-success">
                                    <span class="avatar-initials"><i class="bi-people"></i></span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <span class="d-block h6 text-cap">Участников в группе</span>
                                <span class="d-block h4 mb-0">{{ session.group.participants.count }}</span>
                                <span class="d-block text-muted">Ожидают отметки</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Stats Cards -->

        <!-- QR Codes Nav -->
        <div class="js-nav-scroller hs-nav-scroller-horizontal mb-3">
            <span class="hs-nav-scroller-arrow-prev" style="display: none;">
                <a class="hs-nav-scroller-arrow-prev-btn">
                    <i class="bi-chevron-left"></i>
                </a>
            </span>
            <span class="hs-nav-scroller-arrow-next" style="display: none;">
                <a class="hs-nav-scroller-arrow-next-btn">
                    <i class="bi-chevron-right"></i>
                </a>
            </span>

            <ul class="nav nav-tabs align-items-center" id="qrTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entry" type="button" role="tab" aria-controls="entry" aria-selected="true">
                        <i class="bi-box-arrow-in-right me-2"></i>Вход
                    </button>
                </li>
                {% if session.group.track_exit %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exit-tab" data-bs-toggle="tab" data-bs-target="#exit" type="button" role="tab" aria-controls="exit" aria-selected="false">
                        <i class="bi-box-arrow-right me-2"></i>Выход
                    </button>
                </li>
                {% endif %}
            </ul>
        </div>
        <!-- End QR Codes Nav -->

        <!-- Tab Content -->
        <div class="tab-content" id="qrTabContent">
            <!-- Entry Tab -->
            <div class="tab-pane fade show active" id="entry" role="tabpanel" aria-labelledby="entry-tab">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h4 class="card-header-title">
                                    <i class="bi-box-arrow-in-right me-2"></i>QR-код для входа
                                </h4>
                                <p class="card-header-text">Отметка прихода участников на занятие</p>
                            </div>
                            <div class="col-auto">
                                <div class="d-flex gap-2">
                                    {% if session.qr_file_entry %}
                                        <a class="btn btn-outline-primary btn-sm" href="{{ session.qr_file_entry.url }}" download>
                                            <i class="bi-download me-1"></i> Скачать SVG
                                        </a>
                                    {% endif %}
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="mode" value="entry">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            {% if session.qr_file_entry %}
                                                <i class="bi-download me-1"></i> Скачать PDF
                                            {% else %}
                                                <i class="bi-plus me-1"></i> Сгенерировать
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body text-center">
                        {% if session.qr_file_entry %}
                            <div class="mb-4">
                                <img src="{{ session.qr_file_entry.url }}" alt="QR-код для входа" 
                                     style="max-width: 500px; width: 100%; height: auto;" 
                                     class="img-fluid rounded">
                            </div>
                            
                            <div class="row justify-content-center">
                                <div class="col-sm-8 col-md-6">
                                    <div class="alert alert-soft-success" role="alert">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="bi-check-circle"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-2">
                                                <strong>QR-код готов!</strong><br>
                                                Участники могут сканировать его для отметки входа.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <img class="img-fluid mb-3" src="{% static 'main/assets/svg/illustrations/oc-error.svg' %}" alt="QR-код не создан" style="max-width: 10rem;" data-hs-theme-appearance="default">
                                <img class="img-fluid mb-3" src="{% static 'main/assets/svg/illustrations-light/oc-error.svg' %}" alt="QR-код не создан" style="max-width: 10rem;" data-hs-theme-appearance="dark">
                                
                                <div class="row justify-content-center">
                                    <div class="col-sm-7 col-md-5">
                                        <h4>QR-код не создан</h4>
                                        <p class="text-muted">Нажмите кнопку "Сгенерировать" для создания QR-кода входа.</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- End Entry Tab -->

            <!-- Exit Tab -->
            {% if session.group.track_exit %}
            <div class="tab-pane fade" id="exit" role="tabpanel" aria-labelledby="exit-tab">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <h4 class="card-header-title">
                                    <i class="bi-box-arrow-right me-2"></i>QR-код для выхода
                                </h4>
                                <p class="card-header-text">Отметка ухода участников с занятия</p>
                            </div>
                            <div class="col-auto">
                                <div class="d-flex gap-2">
                                    {% if session.qr_file_exit %}
                                        <a class="btn btn-outline-primary btn-sm" href="{{ session.qr_file_exit.url }}" download>
                                            <i class="bi-download me-1"></i> Скачать SVG
                                        </a>
                                    {% endif %}
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="mode" value="exit">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            {% if session.qr_file_exit %}
                                                <i class="bi-download me-1"></i> Скачать PDF
                                            {% else %}
                                                <i class="bi-plus me-1"></i> Сгенерировать
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body text-center">
                        {% if session.qr_file_exit %}
                            <div class="mb-4">
                                <img src="{{ session.qr_file_exit.url }}" alt="QR-код для выхода" 
                                     style="max-width: 500px; width: 100%; height: auto;" 
                                     class="img-fluid rounded">
                            </div>
                            
                            <div class="row justify-content-center">
                                <div class="col-sm-8 col-md-6">
                                    <div class="alert alert-soft-success" role="alert">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="bi-check-circle"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-2">
                                                <strong>QR-код готов!</strong><br>
                                                Участники могут сканировать его для отметки выхода.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <img class="img-fluid mb-3" src="{% static 'main/assets/svg/illustrations/oc-error.svg' %}" alt="QR-код не создан" style="max-width: 10rem;" data-hs-theme-appearance="default">
                                <img class="img-fluid mb-3" src="{% static 'main/assets/svg/illustrations-light/oc-error.svg' %}" alt="QR-код не создан" style="max-width: 10rem;" data-hs-theme-appearance="dark">
                                
                                <div class="row justify-content-center">
                                    <div class="col-sm-7 col-md-5">
                                        <h4>QR-код не создан</h4>
                                        <p class="text-muted">Нажмите кнопку "Сгенерировать" для создания QR-кода выхода.</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- End Exit Tab -->
        </div>
        <!-- End Tab Content -->

        <!-- Instructions Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="card-header-title">
                    <i class="bi-info-circle me-2"></i>Инструкция по использованию
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Для тренеров:</h6>
                        <ul class="list-py-2">
                            <li>Сгенерируйте QR-коды для входа и выхода</li>
                            <li>Покажите QR-код участникам в начале/конце занятия</li>
                            <li>Следите за отметками в реальном времени</li>
                            <li>При необходимости отмечайте участников вручную</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Для участников:</h6>
                        <ul class="list-py-2">
                            <li>Откройте камеру на своем телефоне</li>
                            <li>Наведите на QR-код</li>
                            <li>Перейдите по ссылке для отметки</li>
                            <li>Подтвердите свое присутствие</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Instructions Card -->
    </div>
    <!-- End Content -->
{% endblock %}

{% block extra_js %}
    <!-- JS Implementing Plugins -->
    <script src="{% static 'main/assets/vendor/hs-nav-scroller/dist/hs-nav-scroller.min.js' %}"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize nav scroller
        new HSNavScroller('.js-nav-scroller');

        // Данные для проверки статуса QR-кодов
        const hasEntryQr = {% if session.qr_file_entry %}true{% else %}false{% endif %};
        const hasExitQr = {% if session.qr_file_exit %}true{% else %}false{% endif %};
        const trackExit = {{ session.group.track_exit|yesno:"true,false" }};

        // Умный auto-refresh только если QR коды еще не созданы
        function checkQRStatus() {
            // Обновляем только если есть несозданные QR коды и страница активна
            if (!document.hidden && (!hasEntryQr || (trackExit && !hasExitQr))) {
                // Используем AJAX вместо полной перезагрузки
                fetch(window.location.href)
                    .then(response => response.text())
                    .then(html => {
                        // Проверяем, появились ли новые QR коды
                        if (html.includes('qr_file_entry') || html.includes('qr_file_exit')) {
                            location.reload(); // Перезагружаем только если появились новые QR
                        }
                    })
                    .catch(err => console.log('Ошибка проверки статуса QR:', err));
            }
        }
        
        // Проверяем статус каждые 10 секунд и только при необходимости
        const refreshInterval = setInterval(checkQRStatus, 10000);
        
        // Останавливаем проверки если все QR коды созданы
        if (hasEntryQr && (!trackExit || hasExitQr)) {
            clearInterval(refreshInterval);
        }
    });
    </script>
{% endblock %}
