{% extends "base.html" %}
{% load i18n groups_extras %}

{% block title %}{% trans "–ú–æ–∏ –≥—Ä—É–ø–ø—ã" %}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">{% trans "–í–∞—à–∏ –≥—Ä—É–ø–ø—ã" %}</h2>

    {% if groups %}
        {% for group in groups %}
            {% if user in group.trainers.all %}
                {# üíº –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —Ç—Ä–µ–Ω–µ—Ä #}
                <div class="card mb-4">
                    <div class="card-header">
                        <strong>{{ group.code }}</strong> ‚Äî {{ group.course_name }}
                    </div>
                    <div class="card-body">
                        <p><strong>{% trans "–¢—Ä–µ–Ω–µ—Ä" %}:</strong> {{ group.supervisor_name }}</p>
                        <p><strong>{% trans "–î–∞—Ç—ã" %}:</strong> {{ group.start_date }} ‚Äî {{ group.end_date }}</p>

                        <p><strong>QR Entry:</strong> {{ group.sessions.first.qr_token_entry }}</p>
                        <p><strong>QR Exit:</strong> {{ group.sessions.first.qr_token_exit }}</p>

                        <hr>
                        <h5>{% trans "–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã" %}</h5>
                        <ul>
                            {% for person in group.participants.all %}
                                <li>{{ person.full_name }} ({{ person.iin }})</li>
                            {% endfor %}
                        </ul>

                        {% if group.sessions.all %}
                            <hr>
                            <h5>{% trans "–°–µ—Å—Å–∏–∏" %}:</h5>
                            <ul class="list-group">
                                {% for session in group.sessions.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ session.date }}
                                        <span>
                                            üïò {{ session.entry_start }} ‚Äî {{ session.entry_end }}
                                            |
                                            üïî {{ session.exit_start }} ‚Äî {{ session.exit_end }}<br>
                                            <small>QR Entry: {{ session.qr_token_entry }}</small><br>
                                            <small>QR Exit: {{ session.qr_token_exit }}</small>
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% if user in group.trainers.all %}
    {# –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤—ã–≤–æ–¥ —Ç—Ä–µ–Ω–µ—Ä–∞ ... #}

    {% for session in group.sessions.all %}
        <h6>–°–µ—Å—Å–∏—è {{ session.date }}</h6>
        <table class="table table-bordered table-sm mb-4">
            <thead>
                <tr>
                    <th>–§–ò–û (–ò–ò–ù)</th>
                    <th>–í—Ö–æ–¥</th>
                    <th>–°—Ç–∞—Ç—É—Å –≤—Ö–æ–¥–∞</th>
                    <th>–í—ã—Ö–æ–¥</th>
                    <th>–°—Ç–∞—Ç—É—Å –≤—ã—Ö–æ–¥–∞</th>
                    <th>–î–æ–≤–µ—Ä–∏–µ</th>
                    <th>–ë–∞–ª–ª—ã –¥–æ–≤–µ—Ä–∏—è</th>
                    <th>–û—Ç–º–µ—Ç–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for participant in group.participants.all %}
                    {% with attendance=attendance_map|get_item:group.id|get_item:session.id|get_item:participant.id %}
                        <tr>
                            <td>{{ participant.full_name }} ({{ participant.iin }})</td>
                            <td>
                                {% if attendance and attendance.arrived_at %}
                                    {{ attendance.arrived_at|date:"d M Y H:i" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance %}
                                    {{ attendance.get_arrived_status_display }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance and attendance.left_at %}
                                    {{ attendance.left_at|date:"d M Y H:i" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance %}
                                    {{ attendance.get_left_status_display }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance %}
                                    {{ attendance.get_trust_level_display }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance %}
                                    {{ attendance.trust_score }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if attendance and attendance.marked_by_trainer %}
                                    –î–∞
                                {% else %}
                                    –ù–µ—Ç
                                {% endif %}
                            </td>
                        </tr>
                    {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
{% endif %}

                    </div>
                </div>
            {% else %}
                {# üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫ #}
                <div class="card mb-4">
                    <div class="card-header">
                        <strong>{{ group.code }}</strong> ‚Äî {{ group.course_name }}
                    </div>
                    <div class="card-body">
                        <p><strong>{% trans "–¢—Ä–µ–Ω–µ—Ä" %}:</strong> {{ group.supervisor_name }}</p>
                        <p><strong>{% trans "–î–∞—Ç—ã" %}:</strong> {{ group.start_date }} ‚Äî {{ group.end_date }}</p>

                {% if group.sessions.all %}
    <hr>
    <h5>{% trans "–°–µ—Å—Å–∏–∏ –∏ –æ—Ç–º–µ—Ç–∫–∏" %}:</h5>
    <ul class="list-group">
        {% for session in group.sessions.all %}
            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {{ session.date }}
                        üïò {{ session.entry_start }} ‚Äî {{ session.entry_end }} |
                        üïî {{ session.exit_start }} ‚Äî {{ session.exit_end }}
                    </div>
                    <div>
                        {% with attendance=attendance_map|get_item:group.id|get_item:session.id %}
                            {% if attendance %}
                                <strong>{% trans "–í—Ö–æ–¥" %}:</strong> {{ attendance.arrived_at|date:"H:i" }} ({{ attendance.get_arrived_status_display }})<br>
                                <strong>{% trans "–í—ã—Ö–æ–¥" %}:</strong> {{ attendance.left_at|date:"H:i" }} ({{ attendance.get_left_status_display }})<br>
                                {% if attendance.marked_by_trainer %}
                                    <small class="text-info">
                                        {% trans "–û—Ç–º–µ—Ç–∫–∞ —Å–¥–µ–ª–∞–Ω–∞ —Ç—Ä–µ–Ω–µ—Ä–æ–º:" %} {{ attendance.marked_by_trainer.full_name }}
                                    </small>
                                {% endif %}
                            {% else %}
                                <em class="text-muted">{% trans "–û—Ç–º–µ—Ç–æ–∫ –Ω–µ—Ç" %}</em>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </li>
        {% endfor %}
    </ul>
{% endif %}

                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <p class="text-muted">{% trans "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø." %}</p>
    {% endif %}
</div>
{% endblock %}
