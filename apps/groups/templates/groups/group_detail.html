{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ group.code }} - Посещаемость - {{ block.super }}{% endblock %}

{% block content %}
    <!-- Content -->
    <div class="content container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <div class="row align-items-center mb-3">
                <div class="col-sm mb-2 mb-sm-0">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb breadcrumb-no-gutter">
                            <li class="breadcrumb-item"><a class="breadcrumb-link" href="{% url 'groups:trainer_groups' %}">Мои группы</a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ group.code }}</li>
                        </ol>
                    </nav>
                    <h1 class="page-header-title">Посещаемость группы: {{ group.code }} <span class="badge bg-soft-dark text-dark ms-2">{{ group.participants.count }}</span></h1>
                </div>
                <!-- End Col -->

                <div class="col-sm-auto">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#legendModal">
                            <i class="bi-info-circle me-1"></i> Легенда
                        </button>
                    </div>
                </div>
                <!-- End Col -->
            </div>
            <!-- End Row -->
        </div>
        <!-- End Page Header -->

        <div class="row justify-content-end mb-3">
            <div class="col-lg">
                <!-- Datatable Info -->
                <div id="datatableCounterInfo" style="display: none;">
                    <div class="d-sm-flex justify-content-lg-end align-items-sm-center">
                        <span class="d-block d-sm-inline-block fs-5 me-3 mb-2 mb-sm-0">
                            <span id="datatableCounter">0</span>
                            Выбрано
                        </span>
                        <a class="btn btn-outline-danger btn-sm mb-2 mb-sm-0 me-2" href="javascript:;">
                            <i class="bi-trash"></i> Удалить
                        </a>
                        <a class="btn btn-white btn-sm mb-2 mb-sm-0 me-2" href="javascript:;">
                            <i class="bi-download"></i> Экспорт выбранных
                        </a>
                        <a class="btn btn-white btn-sm mb-2 mb-sm-0" href="javascript:;">
                            <i class="bi-envelope"></i> Отправить уведомления
                        </a>
                    </div>
                </div>
                <!-- End Datatable Info -->
            </div>
        </div>
        <!-- End Row -->

        <!-- Card -->
        <div class="card">
            <!-- Header -->
            <div class="card-header card-header-content-md-between">
                <div class="mb-2 mb-md-0">
                    <form>
                        <!-- Search -->
                        <div class="input-group input-group-merge input-group-flush">
                            <div class="input-group-prepend input-group-text">
                                <i class="bi-search"></i>
                            </div>
                            <input id="datatableSearch" type="search" class="form-control" placeholder="Поиск участников..." aria-label="Поиск участников">
                        </div>
                        <!-- End Search -->
                    </form>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    <div id="datatable-buttons" class="d-flex gap-2"></div>
                    
                    <button class="btn btn-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasAttendanceFilter" aria-controls="offcanvasAttendanceFilter">
                        <i class="bi-filter me-1"></i> Фильтры
                    </button>

                    <button class="btn btn-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasColumnsFilter" aria-controls="offcanvasColumnsFilter">
                        <i class="bi-table me-1"></i> Колонки <span class="badge bg-soft-dark text-dark rounded-circle ms-1">4</span>
                    </button>
                </div>
            </div>
            <!-- End Header -->

            <!-- Table -->
            <div class="table-responsive datatable-custom">
                <table id="datatable" class="table table-borderless table-thead-bordered table-nowrap table-align-middle card-table" data-hs-datatables-options='{
                         "columnDefs": [{
                            "targets": [0],
                            "width": "5%",
                            "orderable": false
                         }],
                         "order": [],
                         "info": {
                           "totalQty": "#datatableWithPaginationInfoTotalQty"
                         },
                         "search": "#datatableSearch",
                         "entries": "#datatableEntries",
                         "pageLength": 100,
                         "isResponsive": false,
                         "isShowPaging": true,
                         "pagination": "datatablePagination"
                       }'>
                    <thead class="thead-light">
                        <tr id="thead-row">
                            <th>Участник</th>
                            <th>Сегодня</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-tbody"></tbody>
                </table>
            </div>
            <!-- End Table -->

            <!-- Footer -->
            <div class="card-footer">
                <div class="row justify-content-center justify-content-sm-between align-items-sm-center">
                    <div class="col-sm mb-2 mb-sm-0">
                        <div class="d-flex justify-content-center justify-content-sm-start align-items-center">
                            <span class="me-2">Показывать:</span>

                            <!-- Select -->
                            <div class="tom-select-custom">
                                <select id="datatableEntries" class="js-select form-select form-select-borderless w-auto" autocomplete="off" data-hs-tom-select-options='{
                                        "searchInDropdown": false,
                                        "hideSearch": true
                                      }'>
                                    <option value="12">12</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                </select>
                            </div>
                            <!-- End Select -->

                            <span class="text-secondary me-2">из</span>

                            <!-- Pagination Quantity -->
                            <span id="datatableWithPaginationInfoTotalQty"></span>
                        </div>
                    </div>
                    <!-- End Col -->

                    <div class="col-sm-auto">
                        <div class="d-flex justify-content-center justify-content-sm-end">
                            <!-- Pagination -->
                            <nav id="datatablePagination" aria-label="Activity pagination"></nav>
                        </div>
                    </div>
                    <!-- End Col -->
                </div>
                <!-- End Row -->
            </div>
            <!-- End Footer -->
        </div>
        <!-- End Card -->
    </div>
    <!-- End Content -->

    <!-- Filter Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasAttendanceFilter" aria-labelledby="offcanvasAttendanceFilterLabel">
        <div class="offcanvas-header">
            <h4 id="offcanvasAttendanceFilterLabel" class="mb-0">Фильтры</h4>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <span class="text-cap small">Статус посещения</span>

            <div class="d-grid gap-2 mb-2">
                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input js-datatable-filter" type="radio" name="attendanceStatusFilterRadio" value="" id="statusFilterRadio1" data-target-column-index="1">
                    <label class="form-check-label" for="statusFilterRadio1">Все статусы</label>
                </div>
                <!-- End Form Check -->

                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input js-datatable-filter" type="radio" name="attendanceStatusFilterRadio" value="✓" id="statusFilterRadio2" data-target-column-index="1">
                    <label class="form-check-label" for="statusFilterRadio2">Вовремя</label>
                </div>
                <!-- End Form Check -->

                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input js-datatable-filter" type="radio" name="attendanceStatusFilterRadio" value="!" id="statusFilterRadio3" data-target-column-index="1">
                    <label class="form-check-label" for="statusFilterRadio3">Опоздали</label>
                </div>
                <!-- End Form Check -->

                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input js-datatable-filter" type="radio" name="attendanceStatusFilterRadio" value="~" id="statusFilterRadio4" data-target-column-index="1">
                    <label class="form-check-label" for="statusFilterRadio4">Рано</label>
                </div>
                <!-- End Form Check -->

                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input js-datatable-filter" type="radio" name="attendanceStatusFilterRadio" value="?" id="statusFilterRadio5" data-target-column-index="1">
                    <label class="form-check-label" for="statusFilterRadio5">Неизвестно</label>
                </div>
                <!-- End Form Check -->
            </div>

            <a class="link mt-2" href="javascript:;" onclick="clearFilters()">
                <i class="bi-x"></i> Очистить
            </a>

            <hr>

            <span class="text-cap small">Тип отметки</span>

            <div class="d-grid gap-2 mb-2">
                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="manualMarkFilter">
                    <label class="form-check-label" for="manualMarkFilter">Только ручные отметки</label>
                </div>
                <!-- End Form Check -->

                <!-- Form Check -->
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="qrMarkFilter">
                    <label class="form-check-label" for="qrMarkFilter">Только QR-отметки</label>
                </div>
                <!-- End Form Check -->
            </div>

            <a class="link mt-2" href="javascript:;" onclick="clearFilters()">
                <i class="bi-x"></i> Очистить
            </a>
        </div>
        <!-- End Body -->

        <!-- Footer -->
        <div class="offcanvas-footer">
            <div class="row gx-2">
                <div class="col">
                    <div class="d-grid">
                        <button type="button" class="btn btn-white" onclick="clearFilters()">Очистить все фильтры</button>
                    </div>
                </div>
                <!-- End Col -->

                <div class="col">
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="offcanvas">Применить</button>
                    </div>
                </div>
                <!-- End Col -->
            </div>
            <!-- End Row -->
        </div>
        <!-- End Footer -->
    </div>
    <!-- End Filter Offcanvas -->

    <!-- Columns Offcanvas -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasColumnsFilter" aria-labelledby="offcanvasColumnsFilterLabel">
        <div class="offcanvas-header">
            <h4 id="offcanvasColumnsFilterLabel" class="mb-0">Колонки</h4>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <span class="text-cap small">Выберите видимые колонки</span>

            <div class="d-grid gap-3 mb-4">
                <!-- Form Switch -->
                <label class="row form-check form-switch" for="toggleColumn_participant">
                    <span class="col-8 col-sm-9 ms-0">
                        <span class="me-2">Участник</span>
                    </span>
                    <span class="col-4 col-sm-3 text-end">
                        <input type="checkbox" class="form-check-input column-toggle" id="toggleColumn_participant" checked data-column="0">
                    </span>
                </label>
                <!-- End Form Switch -->

                <!-- Form Switch -->
                <label class="row form-check form-switch" for="toggleColumn_today">
                    <span class="col-8 col-sm-9 ms-0">
                        <span class="me-2">Сегодня</span>
                    </span>
                    <span class="col-4 col-sm-3 text-end">
                        <input type="checkbox" class="form-check-input column-toggle" id="toggleColumn_today" checked data-column="1">
                    </span>
                </label>
                <!-- End Form Switch -->

                <!-- Dynamic session columns will be added here by JavaScript -->
                <div id="dynamic-columns"></div>
            </div>

            <a class="link" href="javascript:;" onclick="resetColumns()">
                <i class="bi-arrow-clockwise"></i> Сбросить к начальному состоянию
            </a>
        </div>
    </div>
    <!-- End Columns Offcanvas -->

    <!-- Legend Modal -->
    <div class="modal fade" id="legendModal" tabindex="-1" aria-labelledby="legendModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="legendModalLabel">Легенда обозначений</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-soft-success text-success me-3">✓</span>
                                <div>
                                    <strong>Вовремя</strong>
                                    <p class="text-muted mb-0">Участник пришел в установленное время</p>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-soft-warning text-warning me-3">!</span>
                                <div>
                                    <strong>Опоздал</strong>
                                    <p class="text-muted mb-0">Участник пришел с опозданием</p>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-soft-info text-info me-3">~</span>
                                <div>
                                    <strong>Рано</strong>
                                    <p class="text-muted mb-0">Участник пришел слишком рано</p>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-soft-secondary text-secondary me-3">?</span>
                                <div>
                                    <strong>Неизвестно</strong>
                                    <p class="text-muted mb-0">Статус не определен</p>
                                </div>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-soft-primary text-primary me-3">*</span>
                                <div>
                                    <strong>Отметка вручную</strong>
                                    <p class="text-muted mb-0">Участник отмечен тренером вручную</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Понятно</button>
                </div>
            </div>
        </div>
    </div>
    <!-- End Legend Modal -->
{% endblock %}

{% block extra_js %}
    <!-- JS Implementing Plugins -->
    <script src="{% static 'main/assets/vendor/datatables/media/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/datatables.net.extensions/select/select.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/jszip/dist/jszip.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/pdfmake/build/pdfmake.min.js' %}"></script>
    <script src="{% static 'main/assets/vendor/pdfmake/build/vfs_fonts.js' %}"></script>


    <script>
    // Глобальные переменные для доступа из функций
    let sessions = [];
    let participants = [];
    
    document.addEventListener("DOMContentLoaded", async () => {
        const res = await fetch("{% url 'groups:attendance_json' group.id %}");
        const raw = await res.json();

        const sessionsMap = new Map();
        const participantsMap = new Map();

        raw.data.forEach(a => {
            sessionsMap.set(a.session_id, a.date);
            if (!participantsMap.has(a.participant_id)) {
                participantsMap.set(a.participant_id, {
                    id: a.participant_id,
                    name: a.participant,
                    attendance: {}
                });
            }
            participantsMap.get(a.participant_id).attendance[a.session_id] = a;
        });

        sessions = Array.from(sessionsMap.entries()).sort((a, b) => new Date(a[1]) - new Date(b[1]));
        participants = Array.from(participantsMap.values());

        const todayISO = new Date().toISOString().slice(0, 10);

        // Шапка таблицы
        const thead = document.getElementById("thead-row");

        // Вставляем остальные сессии после "Сегодня"
        sessions.forEach(([session_id, date]) => {
            const th = document.createElement("th");
            const link = `{% url 'groups:session_qr_pdf' 99999 %}`.replace("99999", session_id);
            th.innerHTML = formatDate(date) + '<br><a href="' + link + '" target="_blank" class="btn btn-xs btn-outline-primary">QR</a>';
            thead.appendChild(th);
        });

        // Тело таблицы
        const tbody = document.getElementById("attendance-tbody");

        participants.forEach((p, i) => {
            const todaySession = sessions.find(([_, date]) => date === todayISO);
            let todayCell = '<td>-</td>';
            if (todaySession) {
                const a = p.attendance[todaySession[0]];
                if (a) {
                    todayCell = '<td class="text-start">' +
                        '<div><strong></strong> ' + getStatusBadge(a.arrived_status, a.marked_entry) + ' ' + (a.arrived_at || '') + '</div>' +
                        '<div><strong></strong> ' + getStatusBadge(a.left_status, a.marked_exit) + ' ' + (a.left_at || '') + '</div>' +
                        '</td>';
                }
            }

            // Собираем HTML строки
            const tr = document.createElement("tr");
            let innerHTML = '<td data-export="' + p.name + '">' +
                '<a class="d-flex align-items-center" href="/groups/{{ group.id }}/manual-attendance/' + p.id + '/" target="_blank">' +
                '<div class="flex-shrink-0">' +
                '<div class="avatar avatar-sm avatar-circle">' +
                '<span class="avatar-initials d-print-none">' + p.name.slice(0, 1).toUpperCase() + '</span>' +
                '</div>' +
                '</div>' +
                '<div class="flex-grow-1 ms-3">' +
                '<h5 class="text-inherit mb-0">' + p.name + '</h5>' +
                '</div>' +
                '</a>' +
                '</td>' +
                todayCell;

            sessions.forEach(([id]) => {
                const a = p.attendance[id];
                if (!a) {
                    innerHTML += '<td>-</td>';
                } else {
                    innerHTML += '<td class="text-start">' +
                        '<div><strong></strong> ' + getStatusBadge(a.arrived_status, a.marked_entry) + ' ' + (a.arrived_at || '') + '</div>' +
                        '<div><strong></strong> ' + getStatusBadge(a.left_status, a.marked_exit) + ' ' + (a.left_at || '') + '</div>' +
                        '</td>';
                }
            });

            tr.innerHTML = innerHTML;

            tbody.appendChild(tr);
        });

        // Инициализация DataTable с кнопками экспорта
        HSCore.components.HSDatatables.init($('#datatable'), {
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excel',
                    className: 'btn btn-outline-secondary me-2',
                    text: '<i class="bi-file-earmark-excel me-1"></i> Excel',
                    action: function(e, dt, button, config) {
                        exportToExcel();
                    }
                },
                {
                    extend: 'pdf',
                    className: 'btn btn-outline-secondary me-2',
                    text: '<i class="bi-file-earmark-pdf me-1"></i> PDF',
                    title: 'Посещаемость группы: {{ group.code|escapejs }}',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    action: function(e, dt, button, config) {
                        exportToPDF();
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/ru.json',
                zeroRecords: '<div class="text-center p-4">' +
                    '<img class="mb-3" src="{% static 'main/assets/svg/illustrations/oc-error.svg' %}" alt="Нет данных" style="width: 10rem;" data-hs-theme-appearance="default">' +
                    '<img class="mb-3" src="{% static 'main/assets/svg/illustrations-light/oc-error.svg' %}" alt="Нет данных" style="width: 10rem;" data-hs-theme-appearance="dark">' +
                    '<p class="mb-0">Нет данных для отображения</p>' +
                    '</div>'
            }
        });

        const datatable = HSCore.components.HSDatatables.getItem('datatable');

        // Перемещаем кнопки DataTables в наш контейнер
        setTimeout(() => {
            const buttons = $('.dataTables_wrapper .dt-buttons');
            buttons.appendTo('#datatable-buttons');
        }, 100);

        // Filter functionality
        document.querySelectorAll('.js-datatable-filter').forEach(function (item) {
            item.addEventListener('change', function(e) {
                var elVal = e.target.value,
                    targetColumnIndex = e.target.getAttribute('data-target-column-index');

                datatable.column(targetColumnIndex).search(elVal).draw();
            });
        });

        // Search with mouse up event like in ecommerce-products
        $('#datatableSearch').on('mouseup', function (e) {
            var $input = $(this),
                oldValue = $input.val();

            if (oldValue == "") return;

            setTimeout(function(){
                var newValue = $input.val();
                if (newValue == ""){
                    datatable.search('').draw();
                }
            }, 1);
        });

        // Динамическое создание переключателей колонок для сессий
        createDynamicColumnToggles();
        updateColumnsBadge(); // Инициализация badge

        // Column toggle functionality с делегированными событиями
        $(document).on('change', '.column-toggle', function (e) {
            const columnIndex = parseInt(e.target.getAttribute('data-column'));
            datatable.columns(columnIndex).visible(e.target.checked);
            updateColumnsBadge();
        });

        // Initialize TomSelect
        HSCore.components.HSTomSelect.init('.js-select');
    });

    function getStatusBadge(status, isManual) {
        if (isManual) {
            return '<span class="badge bg-soft-primary text-primary">*</span>';
        }
        
        switch (status) {
            case 'on_time': 
                return '<span class="badge bg-soft-success text-success">✓</span>';
            case 'too_late': 
                return '<span class="badge bg-soft-warning text-warning">!</span>';
            case 'too_early': 
                return '<span class="badge bg-soft-info text-info">~</span>';
            case 'unknown': 
                return '<span class="badge bg-soft-secondary text-secondary">?</span>';
            default: 
                return '<span class="text-muted">-</span>';
        }
    }

    function convertHtmlToText(htmlString) {
        if (!htmlString || htmlString === '-') {
            return '-';
        }
        
        // Создаем временный div для парсинга HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString;
        
        const lines = [];
        const divElements = tempDiv.querySelectorAll('div');
        
        if (divElements.length === 0) {
            // Если нет div элементов, просто извлекаем текст
            return tempDiv.textContent || tempDiv.innerText || '-';
        }
        
        divElements.forEach((div, index) => {
            let lineText = '';
            
            // Добавляем префикс для входа/выхода
            const prefix = index === 0 ? ' ' : ' ';
            lineText += prefix;
            
            // Извлекаем символ из badge
            const badge = div.querySelector('.badge');
            if (badge) {
                const symbol = badge.textContent.trim();
                if (symbol) {
                    lineText += symbol + ' ';
                }
            }
            
            // Извлекаем время (все что не в badge)
            const allText = div.textContent || div.innerText || '';
            const badgeText = badge ? badge.textContent || '' : '';
            const timeText = allText.replace(badgeText, '').trim();
            
            if (timeText) {
                lineText += timeText;
            } else {
                lineText += '-';
            }
            
            lines.push(lineText.trim());
        });
        
        return lines.length > 0 ? lines.join('\n') : '-';
    }

    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
    }

    function clearFilters() {
        document.querySelectorAll('.js-datatable-filter').forEach(el => el.checked = false);
        const datatable = HSCore.components.HSDatatables.getItem('datatable');
        datatable.search('').columns().search('').draw();
    }

    function createDynamicColumnToggles() {
        const dynamicContainer = document.getElementById('dynamic-columns');
        
        sessions.forEach(([sessionId, sessionDate], index) => {
            const columnIndex = index + 2; // 0=Участник, 1=Сегодня, 2+=Сессии
            const sessionLabel = formatDate(sessionDate);
            
            const toggleHtml = '<label class="row form-check form-switch" for="toggleColumn_session_' + sessionId + '">' +
                '<span class="col-8 col-sm-9 ms-0">' +
                '<span class="me-2">' + sessionLabel + '</span>' +
                '</span>' +
                '<span class="col-4 col-sm-3 text-end">' +
                '<input type="checkbox" class="form-check-input column-toggle" id="toggleColumn_session_' + sessionId + '" checked data-column="' + columnIndex + '">' +
                '</span>' +
                '</label>';
            
            dynamicContainer.innerHTML += toggleHtml;
        });
    }

    function updateColumnsBadge() {
        const visibleColumns = document.querySelectorAll('.column-toggle:checked').length;
        const badge = document.querySelector('.badge.bg-soft-dark');
        if (badge) {
            badge.textContent = visibleColumns;
        }
    }

    function resetColumns() {
        document.querySelectorAll('.column-toggle').forEach(toggle => {
            toggle.checked = true;
            const columnIndex = parseInt(toggle.getAttribute('data-column'));
            const datatable = HSCore.components.HSDatatables.getItem('datatable');
            datatable.columns(columnIndex).visible(true);
        });
        updateColumnsBadge();
    }

    // Функции экспорта
    function exportToExcel() {
        const exportData = prepareExportData();
        
        // Создаем HTML таблицу с объединением ячеек
        let htmlContent = `
<html>
<head>
    <meta charset="utf-8">
    <title>Посещаемость группы: {{ group.code|escapejs }}</title>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
        .participant { text-align: left; }
        .on-time { background-color: #d1edff; color: #0d6efd; }
        .too-late { background-color: #fff3cd; color: #664d03; }
        .too-early { background-color: #cff4fc; color: #055160; }
        .unknown { background-color: #f8f9fa; color: #6c757d; }
        .manual { background-color: #e7f3ff; color: #0c5aa6; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Посещаемость группы: {{ group.code|escapejs }}</h1>
    <table>
        <thead>
            <tr>`;
        
        // Первая строка заголовков с объединением ячеек
        exportData.topHeaders.forEach((header, index) => {
            if (index === 0) {
                htmlContent += `<th rowspan="2" style="background-color: #f8f9fa; font-weight: bold;">${header}</th>`;
            } else if (header !== '') {
                htmlContent += `<th colspan="2" style="background-color: #f8f9fa; font-weight: bold;">${header}</th>`;
            }
        });
        
        htmlContent += '</tr><tr>';
        
        // Вторая строка заголовков (только вход/выход)
        exportData.subHeaders.forEach((header, index) => {
            if (index > 0) { // Пропускаем первую пустую ячейку для участника
                htmlContent += `<th style="background-color: #e9ecef; font-weight: bold;">${header}</th>`;
            }
        });
        
        htmlContent += '</tr></thead><tbody>';
        
        // Строки данных
        exportData.rows.forEach(row => {
            htmlContent += '<tr>';
            row.forEach((cell, index) => {
                let className = '';
                let cellText = cell.text;
                
                if (index === 0) {
                    className = 'participant';
                } else {
                    // Определяем CSS класс по цвету
                    if (cell.fillColor === '#d1edff') className = 'on-time';
                    else if (cell.fillColor === '#fff3cd') className = 'too-late';
                    else if (cell.fillColor === '#cff4fc') className = 'too-early';
                    else if (cell.fillColor === '#e7f3ff') className = 'manual';
                    else if (cell.fillColor === '#f8f9fa') className = 'unknown';
                }
                
                htmlContent += `<td class="${className}">${cellText}</td>`;
            });
            htmlContent += '</tr>';
        });
        
        htmlContent += `
        </tbody>
    </table>
</body>
</html>`;

        // Создаем blob и скачиваем
        const blob = new Blob([htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Посещаемость_{{ group.code|escapejs }}_' + new Date().toISOString().slice(0, 10) + '.xls';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function exportToPDF() {
        const exportData = prepareExportData();
        
        const docDefinition = {
            pageOrientation: 'landscape',
            pageSize: 'A4',
            pageMargins: [20, 60, 20, 40],
            content: [
                {
                    text: 'Посещаемость группы: {{ group.code|escapejs }}',
                    style: 'header',
                    alignment: 'center',
                    margin: [0, 0, 0, 20]
                },
                {
                    table: {
                        headerRows: 2,
                        widths: ['auto', ...Array(exportData.topHeaders.length - 1).fill('*')],
                        body: [
                            // Первая строка заголовков (даты)
                            exportData.topHeaders.map(header => ({ 
                                text: header, 
                                fillColor: '#f8f9fa',
                                bold: true,
                                alignment: 'center'
                            })),
                            // Вторая строка заголовков (вход/выход)
                            exportData.subHeaders.map(header => ({ 
                                text: header, 
                                fillColor: '#e9ecef',
                                bold: true,
                                alignment: 'center'
                            })),
                            // Строки данных
                            ...exportData.rows.map(row => row.map(cell => ({
                                text: cell.text,
                                fillColor: cell.fillColor || null,
                                color: cell.color || '#000000'
                            })))
                        ]
                    },
                    layout: 'lightHorizontalLines'
                }
            ],
            styles: {
                header: {
                    fontSize: 16,
                    bold: true
                }
            }
        };

        pdfMake.createPdf(docDefinition).download('Посещаемость_{{ group.code|escapejs }}_' + new Date().toISOString().slice(0, 10) + '.pdf');
    }

    function prepareExportData() {
        const todayISO = new Date().toISOString().slice(0, 10);
        
        // Создаем двухуровневые заголовки
        const topHeaders = ['Участник'];
        const subHeaders = [''];
        
        // Добавляем "Сегодня" (если есть)
        const todaySession = sessions.find(([_, date]) => date === todayISO);
        if (todaySession) {
            topHeaders.push('Сегодня', '');
            subHeaders.push('вход', 'выход');
        }
        
        // Добавляем остальные сессии
        sessions.forEach(([sessionId, sessionDate]) => {
            if (sessionDate !== todayISO) {
                const formattedDate = formatDate(sessionDate);
                topHeaders.push(formattedDate, '');
                subHeaders.push('вход', 'выход');
            }
        });

        // Создаем строки данных
        const rows = [];
        participants.forEach(participant => {
            const row = [{ text: participant.name }];
            
            // Добавляем данные "Сегодня"
            if (todaySession) {
                const todayAttendance = participant.attendance[todaySession[0]];
                if (todayAttendance) {
                    // Вход
                    row.push(formatExportCell(
                        todayAttendance.arrived_at,
                        todayAttendance.arrived_status,
                        todayAttendance.marked_entry
                    ));
                    // Выход
                    row.push(formatExportCell(
                        todayAttendance.left_at,
                        todayAttendance.left_status,
                        todayAttendance.marked_exit
                    ));
                } else {
                    row.push({ text: '--' }, { text: '--' });
                }
            }
            
            // Добавляем данные остальных сессий
            sessions.forEach(([sessionId, sessionDate]) => {
                if (sessionDate !== todayISO) {
                    const attendance = participant.attendance[sessionId];
                    if (attendance) {
                        // Вход
                        row.push(formatExportCell(
                            attendance.arrived_at,
                            attendance.arrived_status,
                            attendance.marked_entry
                        ));
                        // Выход
                        row.push(formatExportCell(
                            attendance.left_at,
                            attendance.left_status,
                            attendance.marked_exit
                        ));
                    } else {
                        row.push({ text: '--' }, { text: '--' });
                    }
                }
            });
            
            rows.push(row);
        });

        return { topHeaders, subHeaders, rows };
    }

    function formatExportCell(time, status, isManual) {
        if (!time) {
            return { text: '--' };
        }

        const cellData = { text: time };
        
        // Применяем цветовое кодирование
        if (isManual) {
            cellData.fillColor = '#e7f3ff';
            cellData.color = '#0c5aa6';
        } else {
            switch (status) {
                case 'on_time':
                    cellData.fillColor = '#d1edff';
                    cellData.color = '#0d6efd';
                    break;
                case 'too_late':
                    cellData.fillColor = '#fff3cd';
                    cellData.color = '#664d03';
                    break;
                case 'too_early':
                    cellData.fillColor = '#cff4fc';
                    cellData.color = '#055160';
                    break;
                case 'unknown':
                case null:
                case undefined:
                default:
                    // По умолчанию для неопределенных статусов - серый фон
                    cellData.fillColor = '#f8f9fa';
                    cellData.color = '#6c757d';
                    break;
            }
        }

        return cellData;
    }

    </script>

{% endblock %}
